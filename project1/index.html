<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>A rose is a rose ‚Äî code spiral + sound</title>
<!-- p5.js for visual -->
<script src="https://cdn.jsdelivr.net/npm/p5@1.9.3/lib/p5.min.js"></script>
<!-- Tone.js for audio -->
<script src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.min.js"></script>
<style>
  html,body{margin:0;height:100%;background:#111;color:#eee;font-family:system-ui,Helvetica,Arial;}
  #ui{position:fixed;inset:auto 1rem 1rem 1rem;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  button, input[type=range]{accent-color:#e24;}
  .pill{background:#fff1;padding:.6rem .9rem;border-radius:999px;border:1px solid #333;color:#111}
  .note{opacity:.7}
</style>
</head>
<body>
<div id="ui">
  <button id="start" class="pill">‚ñ∂ Start</button>
  <label class="pill">Speed
    <input id="speed" type="range" min="-2" max="2" step="0.01" value="0.4">
  </label>
  <label class="pill">Zoom
    <input id="zoom" type="range" min="0.6" max="1.4" step="0.01" value="1.0">
  </label>
  <span class="note">Visual: spiral text rotatesÔºõAudio: TTS + synth loop pans around (headphones üîä)</span>
</div>

<script>
/* -------------------- VISUAL (p5.js) -------------------- */
let angle = 0;
let speedSlider, zoomSlider;

const phrase = "A ROSE IS A ROSE IS A ROSE ‚Ä¢ ";

function setup(){
  const c = createCanvas(window.innerWidth, window.innerHeight);
  c.canvas.style.display = "block";
  textAlign(CENTER, CENTER);
  speedSlider = document.getElementById('speed');
  zoomSlider  = document.getElementById('zoom');
}

function windowResized(){ resizeCanvas(window.innerWidth, window.innerHeight); }

function draw(){
  background(17);
  translate(width/2, height/2);
  const zoom = parseFloat(zoomSlider.value);
  scale(zoom);

  // base palette
  noFill();
  stroke(60);
  circle(0,0,6); // tiny core

  // spiral rings (ÂÉèËä±Ëïä‰∏ÄÂ±ÇÂ±ÇÂ§ñÊé®)
  const rings = 12;
  for(let i=0;i<rings;i++){
    const r = 40 + i*28;              // ÂçäÂæÑÈÄíÂ¢û
    const chars = phrase;              // ÊñáÊú¨‰∏≤
    const steps = 64 + i*4;            // ÊØèÂúàÊîæÁΩÆÁöÑÂ≠óÁ¨¶Êï∞
    const size  = 10 + i*2.2;          // Â≠óÂè∑Áî±ÂÜÖÂà∞Â§ñÂèòÂ§ß
    const localRot = angle * (1 + i*0.04); // Â§ñÂúàÁ®çÂø´ÔºåÂÜÖÂúàÁ®çÊÖ¢ ‚Üí Ëä±ÂºÄÊÑü
    push();
    rotate(localRot);
    for(let k=0;k<steps;k++){
      const a = k/steps * TWO_PI;
      const x = r * Math.cos(a);
      const y = r * Math.sin(a);
      push();
      translate(x,y);
      rotate(a + HALF_PI);           // ËÆ©Â≠óÊ≤øÂàáÁ∫øÊñπÂêë
      noStroke();
      fill(235);
      textSize(size);
      text(chars[k % chars.length], 0, 0);
      pop();
    }
    pop();
  }

  // rotate
  angle += parseFloat(speedSlider.value) * 0.01;
}

/* -------------------- AUDIO (Tone.js + Web Speech) -------------------- */
let started = false;
const startBtn = document.getElementById('start');

async function startAudio(){
  if(started) return;
  started = true;

  await Tone.start();           // Ëß£ÈîÅÈü≥È¢ë
  // 1) ÂêàÊàêÂô®ÂÅö‰∏Ä‰∏™ÊûÅÁÆÄ‚ÄúÂëºÂê∏‚ÄùÂû´Â∫ï
  const synth = new Tone.PolySynth(Tone.Synth, {
    oscillator:{type:"sine"}, envelope:{attack:0.8, decay:0.2, sustain:0.3, release:1.6}
  }).toDestination();

  // 2) ÊóãËΩ¨Â£∞ÂÉèÂô®ÔºàÁéØÁªïÊÑü ‚Äî‚Äî ËØ≠Ë®ÄÂú®‰Ω†ËÄ≥Ëæπ‚ÄúÁªïÂúà‚ÄùÔºâ
  const panner = new Tone.Panner(0).toDestination();
  const ping   = new Tone.MembraneSynth({octaves:3, pitchDecay:0.01}).connect(panner);

  // ÊääÂêàÊàêÂô®‰πüÊé•Âà∞ÊóãËΩ¨Â£∞ÂÉèÂô®ÔºåÊï¥‰ΩìÊÖ¢ÊÖ¢ÁéØÁªï
  synth.connect(panner);

  // LoopÔºöÂØπÂ∫î ‚ÄúA rose | is a rose | is a rose‚Äù
  const root = "C4";
  const seq = new Tone.Sequence((time, step)=>{
    // Â∞èÈºìÁÇπÊèêÁ§∫Âè•ËØª
    if(step === 0 || step === 4 || step === 8) ping.triggerAttackRelease("C2", "8n", time);

    // ÂíåÂ£∞Á∫ßËøõÔºöÊØèËΩÆÈáçÂ§çÁï•Âèò ‚Üí ‚ÄúÈáçÂ§ç‰∏≠ÁîüÊàêÂ∑ÆÂºÇ‚Äù
    const chord = [
      Tone.Frequency(root).transpose(0 + step%3),
      Tone.Frequency(root).transpose(7),
      Tone.Frequency(root).transpose(12)
    ];
    synth.triggerAttackRelease(chord, "8n", time);

    // Â£∞ÂÉèÁéØÁªïÔºà-1..1Ôºâ
    const t = Tone.Transport.seconds;
    const pan = Math.sin(t * 0.6);   // ÊÖ¢ÊÖ¢ÁªïÂ§¥ÈÉ®
    panner.pan.rampTo(pan, 0.1);

  }, [...Array(12).keys()], "8n");

  seq.start(0);
  Tone.Transport.bpm.value = 96;
  Tone.Transport.start();

  // 3) Web SpeechÔºöÊú∫Âô®ÊúóËØªÁü≠Âè•Ôºå‰Ωú‰∏∫‚ÄúËØ≠Ë®ÄÁ¥†Êùê‚Äù
  const utt = new SpeechSynthesisUtterance("a rose is a rose is a rose");
  utt.rate = 0.9;  // ÈÄüÁéá
  utt.pitch = 1.0;
  utt.lang = "en-US";

  // Âë®ÊúüÊÄßÊúóËØªÔºà‰∏é Transport ÂØπÈΩêÔºâ
  setInterval(() => { window.speechSynthesis.speak(utt); }, 4000);
}

startBtn.addEventListener('click', startAudio);
</script>
</body>
</html>
